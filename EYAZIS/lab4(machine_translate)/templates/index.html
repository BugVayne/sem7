{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4><i class="fas fa-exchange-alt"></i> Перевод текста</h4>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Предметная область:</label>
                    <div>
                        <span class="badge bg-primary domain-badge me-2" data-domain="computer_science">
                            Computer Science
                        </span>
                        <span class="badge bg-success domain-badge me-2" data-domain="literature">
                            Литература
                        </span>
                        <span class="badge bg-warning domain-badge" data-domain="art_criticism">
                            Критика искусства
                        </span>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">Исходный текст (английский):</label>
                        <textarea class="form-control" id="inputText" rows="8" 
                                  placeholder="Введите текст для перевода..."></textarea>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Перевод (немецкий):</label>
                        <textarea class="form-control" id="outputText" rows="8" 
                                  readonly placeholder="Результат перевода..."></textarea>
                    </div>
                </div>

                <div class="mt-3">
                    <button class="btn btn-primary" id="translateBtn">
                        <i class="fas fa-sync-alt"></i> Перевести
                    </button>
                    <button class="btn btn-success" id="exportBtn" disabled>
                        <i class="fas fa-download"></i> Экспорт результатов
                    </button>
                </div>
            </div>
        </div>

        <!-- Вкладки с результатами -->
        <ul class="nav nav-tabs mt-4" id="resultsTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="analysis-tab" data-bs-toggle="tab" 
                        data-bs-target="#analysis" type="button" role="tab">
                    <i class="fas fa-chart-bar"></i> Анализ текста
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="frequency-tab" data-bs-toggle="tab" 
                        data-bs-target="#frequency" type="button" role="tab">
                    <i class="fas fa-list-ol"></i> Частотный словарь
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="syntax-tab" data-bs-toggle="tab" 
                        data-bs-target="#syntax" type="button" role="tab">
                    <i class="fas fa-project-diagram"></i> Синтаксический анализ
                </button>
            </li>
        </ul>

        <div class="tab-content" id="resultsTabContent">
            <!-- Вкладка анализа -->
            <div class="tab-pane fade show active" id="analysis" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-body">
                        <div id="analysisResults">
                            <p class="text-muted">Введите текст и нажмите "Перевести" для анализа</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Вкладка частотного словаря -->
            <div class="tab-pane fade" id="frequency" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-body">
                        <div class="word-frequency-table">
                            <table class="table table-striped" id="frequencyTable">
                                <thead>
                                    <tr>
                                        <th>Слово</th>
                                        <th>Перевод</th>
                                        <th>Часть речи</th>
                                        <th>Частота</th>
                                        <th>Действия</th>
                                    </tr>
                                </thead>
                                <tbody id="frequencyTableBody">
                                    <!-- Данные будут загружены через JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Вкладка синтаксического анализа -->
            <div class="tab-pane fade" id="syntax" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Выберите предложение для анализа:</label>
                            <select class="form-select" id="sentenceSelector">
                                <option value="">-- Выберите предложение --</option>
                            </select>
                        </div>
                        <div class="syntax-tree" id="syntaxTreeOutput">
                            Дерево синтаксического разбора появится здесь после выбора предложения
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentDomain = 'computer_science';
let currentResults = null;

// Выбор предметной области
document.querySelectorAll('.domain-badge').forEach(badge => {
    badge.addEventListener('click', function() {
        document.querySelectorAll('.domain-badge').forEach(b => b.classList.remove('bg-secondary'));
        this.classList.add('bg-secondary');
        currentDomain = this.dataset.domain;
    });
});

// Перевод текста
document.getElementById('translateBtn').addEventListener('click', async function() {
    const inputText = document.getElementById('inputText').value.trim();
    if (!inputText) {
        alert('Пожалуйста, введите текст для перевода');
        return;
    }

    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Перевод...';

    try {
        const response = await fetch('/translate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                text: inputText,
                domain: currentDomain
            })
        });

        const data = await response.json();

        if (response.ok) {
            currentResults = data;
            document.getElementById('outputText').value = data.translated_text;
            document.getElementById('exportBtn').disabled = false;
            
            // Обновляем анализ
            updateAnalysisTab(data);
            // Обновляем частотный словарь
            updateFrequencyTable(data.word_frequency);
            // Обновляем селектор предложений
            updateSentenceSelector(inputText);
            
            // Активируем вкладку анализа
            new bootstrap.Tab(document.getElementById('analysis-tab')).show();
        } else {
            alert('Ошибка: ' + data.error);
        }
    } catch (error) {
        alert('Ошибка при переводе: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-sync-alt"></i> Перевести';
    }
});

// Экспорт результатов
document.getElementById('exportBtn').addEventListener('click', async function() {
    if (!currentResults) return;

    try {
        const response = await fetch('/export', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(currentResults)
        });

        const data = await response.json();
        if (response.ok) {
            alert('Результаты успешно экспортированы в файл: ' + data.filename);
        } else {
            alert('Ошибка при экспорте: ' + data.error);
        }
    } catch (error) {
        alert('Ошибка при экспорте: ' + error.message);
    }
});

function updateAnalysisTab(data) {
    const analysisDiv = document.getElementById('analysisResults');
    analysisDiv.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h5>Статистика текста:</h5>
                <ul>
                    <li>Слов в исходном тексте: <strong>${data.analysis.word_count}</strong></li>
                    <li>Переведено слов: <strong>${data.translated_word_count}</strong></li>
                </ul>
                
                <h5>Распределение частей речи:</h5>
                <ul>
                    ${Object.entries(data.analysis.pos_stats).map(([tag, count]) => 
                        `<li>${tag}: ${count}</li>`
                    ).join('')}
                </ul>
            </div>
            <div class="col-md-6">
                <h5>Примеры частей речи:</h5>
                <div style="max-height: 200px; overflow-y: auto;">
                    ${data.analysis.pos_tags.slice(0, 20).map(item => 
                        `<span class="badge bg-secondary me-1 mb-1">${item.word} (${item.description})</span>`
                    ).join('')}
                </div>
            </div>
        </div>
    `;
}

function updateFrequencyTable(wordFrequency) {
    const tbody = document.getElementById('frequencyTableBody');
    tbody.innerHTML = wordFrequency.map(item => `
        <tr>
            <td>${item.word}</td>
            <td>${item.translation}</td>
            <td>${item.pos_tag}</td>
            <td>${item.frequency}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="addToDictionary('${item.word}', '${item.translation}', '${item.pos_tag}')">
                    <i class="fas fa-plus"></i> В словарь
                </button>
            </td>
        </tr>
    `).join('');
}

function updateSentenceSelector(inputText) {
    const selector = document.getElementById('sentenceSelector');
    const sentences = inputText.split(/[.!?]+/).filter(s => s.trim().length > 0);
    
    selector.innerHTML = '<option value="">-- Выберите предложение --</option>' +
        sentences.map((sentence, index) => 
            `<option value="${sentence.trim()}">${sentence.trim().substring(0, 50)}...</option>`
        ).join('');
}

// Анализ синтаксиса
document.getElementById('sentenceSelector').addEventListener('change', async function() {
    const sentence = this.value;
    if (!sentence) return;

    try {
        const response = await fetch('/analyze_syntax', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ sentence: sentence })
        });

        const data = await response.json();
        if (response.ok) {
            document.getElementById('syntaxTreeOutput').textContent = data.syntax_tree;
        } else {
            alert('Ошибка: ' + data.error);
        }
    } catch (error) {
        alert('Ошибка при анализе синтаксиса: ' + error.message);
    }
});

// Добавление в словарь
async function addToDictionary(originalWord, translatedWord, posTag) {
    try {
        const response = await fetch('/dictionary/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                original_word: originalWord,
                translated_word: translatedWord,
                pos_tag: posTag
            })
        });

        const data = await response.json();
        if (response.ok) {
            alert('Слово успешно добавлено в словарь!');
        } else {
            alert('Ошибка: ' + data.error);
        }
    } catch (error) {
        alert('Ошибка при добавлении в словарь: ' + error.message);
    }
}
</script>
{% endblock %}